# سامانه حضور و غیاب دانشگاه - بخش بک‌اند (Backend)

<p align="center">
  <img src="https://img.shields.io/badge/Node.js-24.x-339933.svg?style=for-the-badge&logo=node.js" alt="Node.js Version">
  <img src="https://img.shields.io/badge/Express.js-4.x-000000.svg?style=for-the-badge&logo=express" alt="Express.js">
  <img src="https://img.shields.io/badge/MongoDB-8.x-47A248.svg?style=for-the-badge&logo=mongodb" alt="MongoDB">
  <img src="https://img.shields.io/badge/JWT-Auth-d63aff.svg?style=for-the-badge&logo=json-web-tokens" alt="JWT Auth">
</p>

این ریپازیتوری شامل کد کامل بک‌اند برای **سامانه هوشمند حضور و غیاب دانشگاه** است. این سرور با استفاده از Node.js و فریم‌ورک Express ساخته شده و مسئولیت مدیریت تمام منطق‌های کسب‌وکار، احراز هویت، دسترسی‌ها، و تعامل با دیتابیس MongoDB را بر عهده دارد.

## ✨ امکانات و ویژگی‌های کلیدی

این بک‌اند مجموعه‌ای کامل از API های RESTful را برای پشتیبانی از یک سامانه جامع فراهم می‌کند:

### 👨‍💻 مدیریت کاربران و دسترسی‌ها
- **سیستم احراز هویت امن:** مبتنی بر `JWT` با استفاده از `accessToken` (کوتاه‌مدت) و `refreshToken` (بلندمدت) که در کوکی‌های `HttpOnly` ذخیره می‌شوند.
- **کنترل دسترسی مبتنی بر نقش (RBAC):** تفکیک کامل دسترسی‌ها برای نقش‌های **مدیر (Admin)**، **مسئول (Officer)** و **کاربران عادی (Faculty/Staff)**.
- **مدیریت کامل کاربران:** مدیران می‌توانند کاربران جدید ایجاد کرده، اطلاعات آن‌ها را ویرایش و حساب‌های کاربری را فعال یا غیرفعال کنند.
- **پروفایل شخصی:** کاربران می‌توانند اطلاعات شخصی و رمز عبور خود را ویرایش کنند.

### 🕒 مدیریت حضور و غیاب
- **ثبت ورود و خروج:** مسئولین می‌توانند تردد کاربران را ثبت کنند.
- **محاسبه خودکار وضعیت:** تشخیص خودکار وضعیت **"حاضر"**، **"تاخیر"** و **"غایب"** بر اساس تنظیمات سیستمی.
- **ویرایش هوشمند:** مدیران دسترسی کامل به ویرایش رکوردها دارند، در حالی که مسئولین فقط تا زمان محدودی می‌توانند رکوردهای خود را ویرایش کنند.
- **تاریخچه ویرایش (Audit Trail):** تمام تغییرات روی یک رکورد در فیلد `editHistory` برای حسابرسی ذخیره می‌شود.

### 📊 گزارش‌گیری و داشبورد
- **داشبورد مدیریتی جامع:** ارائه آمار لحظه‌ای (KPIs)، نمودار روند حضور، و مقایسه عملکرد واحدها.
- **گزارش‌گیری پیشرفته:** API قدرتمند برای فیلتر کردن گزارشات بر اساس بازه زمانی، کاربر، واحد، نقش و وضعیت.
- **خروجی Excel:** قابلیت دانلود تمام گزارشات فیلتر شده به صورت فایل `.xlsx`.

### ⚙️ تنظیمات پویای سامانه
- **مدیریت کامل تنظیمات:** مدیران می‌توانند تنظیمات کلیدی سامانه مانند نام دانشگاه، لوگو، ساعات کاری، آستانه تاخیر و روزهای کاری را از طریق API مدیریت کنند.
- **بارگذاری در حافظه:** تنظیمات در حافظه کش می‌شوند تا از کوئری‌های تکراری به دیتابیس جلوگیری شود.

### 🧠 هوش مصنوعی و یادگیری ماشین (Python)
- **خوشه‌بندی رفتاری (Clustering):** تقسیم‌بندی خودکار کاربران به گروه‌های رفتاری (منظم، شناور، نیازمند توجه).
- **شناسایی ناهنجاری (Anomaly Detection):** تشخیص خودکار رکوردهای تردد غیرعادی و مشکوک.
- **یکپارچه‌سازی با Node.js:** اجرای اسکریپت‌های پایتون به صورت `child_process` از طریق یک سرویس اختصاصی.

## 🛠️ تکنولوژی‌های استفاده شده

- **محیط اجرایی:** Node.js
- **فریم‌ورک:** Express.js
- **دیتابیس:** MongoDB با Mongoose ODM
- **احراز هویت:** JSON Web Tokens (`jsonwebtoken`), `cookie-parser`
- **امنیت:** `helmet`, `express-rate-limit`, `express-mongo-sanitize`, `cors`
- **اعتبارسنجی:** Joi
- **مدیریت فایل:** Multer
- **تولید Excel:** ExcelJS
- **کار با تاریخ:** Moment.js (Jalaali)
- **یادگیری ماشین:** Python, Scikit-learn, Pandas (اجرا از طریق Node.js)
- **لاگ‌گیری:** Winston

## 🚀 راه‌اندازی و نصب (Setup)

برای راه‌اندازی این پروژه به صورت محلی، مراحل زیر را دنبال کنید:

1.  **پیش‌نیازها:**
    - Node.js (نسخه 16 یا بالاتر)
    - MongoDB (نصب شده به صورت محلی یا استفاده از یک سرویس ابری مانند Atlas)
    - Python (نسخه 3.8 یا بالاتر)

2.  **کلون کردن ریپازیتوری:**
    ```bash
    git clone https://github.com/your-username/attendance-system-backend.git
    cd attendance-system-backend
    ```

3.  **نصب وابستگی‌های Node.js:**
    ```bash
    npm install
    ```

4.  **ایجاد فایل `.env`:**
    یک فایل به نام `.env` در ریشه پروژه بسازید و محتوای فایل `.env.example` را در آن کپی کنید. سپس مقادیر را با اطلاعات محلی خود (مانند `MONGODB_URI` و `JWT_SECRET`) پر کنید.
    ```env
    PORT=5000
    MONGODB_URI=mongodb://localhost:27017/attendance_system
    JWT_SECRET=your_super_secret_jwt_key
    # ... and other variables
    ```

5.  **راه‌اندازی بخش پایتون (یادگیری ماشین):**
    ```bash
    # به پوشه اسکریپت‌ها بروید
    cd ml_scripts
    # محیط مجازی بسازید
    python -m venv venv
    # محیط را فعال کنید
    # Windows: .\venv\Scripts\activate
    # macOS/Linux: source venv/bin/activate
    # وابستگی‌های پایتون را نصب کنید
    pip install -r requirements.txt 
    # مدل‌ها را آموزش دهید
    python train_clustering_model.py
    python train_anomaly_model.py
    # به ریشه پروژه برگردید
    cd ..
    ```
    *(**نکته:** بهتر است یک فایل `requirements.txt` برای پکیج‌های پایتون بسازید)*

6.  **اجرای سرور:**
    ```bash
    # برای حالت توسعه با nodemon
    npm run dev
    # برای حالت Production
    npm start
    ```
    سرور شما روی پورت `5000` (یا هر پورتی که در `.env` مشخص کرده‌اید) اجرا خواهد شد.

---

**مشارکت (Contributing):**
در حال حاضر، این یک پروژه شخصی است، اما اگر پیشنهادی برای بهبود دارید، لطفاً یک Issue باز کنید.

**نویسنده:** علیرضا آبچهره || Alireza Waterface